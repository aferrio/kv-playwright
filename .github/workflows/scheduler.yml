name: Playwright Scheduled Test

on:
  schedule:
    - cron: "*/10 * * * *"  # Esegue ogni 10 minuti
  workflow_dispatch:  # Permette l'esecuzione manuale

jobs:
  run-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run all tests
        id: playwright-test
        run: npx playwright test --reporter=list
        continue-on-error: true

      - name: Get test results
        if: always()
        id: test-results
        run: |
          if [ "${{ steps.playwright-test.outcome }}" = "failure" ]; then
            echo "test_status=failed" >> $GITHUB_OUTPUT
          else
            echo "test_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram notification on failure
        if: steps.test-results.outputs.test_status == 'failed'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          REPO_URL="https://github.com/${{ github.repository }}"
          RUN_URL="$REPO_URL/actions/runs/${{ github.run_id }}"
          
          MESSAGE=$(printf "‚ùå Playwright Tests Failed\n\nüîó Repository: %s\nüìä Run Details: %s\n‚è∞ Time: %s\n\nAll tests executed every 10 minutes via GitHub Actions" "$REPO_URL" "$RUN_URL" "$TIMESTAMP")

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML"

      - name: Send Telegram notification on success
        if: steps.test-results.outputs.test_status == 'passed'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          MESSAGE=$(printf "‚úÖ All Playwright Tests Passed\n\n‚è∞ Time: %s\nüîÑ Next run in 10 minutes" "$TIMESTAMP")

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE"